# Day44: Go仮想ルーター

## 概要
Go言語で仮想ルーターを実装します。TUNデバイスを用いて仮想NICを作成し、IPパケットの送受信を行います。サーバプロセスは1台のみで、各ルーターはgoroutineとして動的に生成・管理されます。OSPF風のダイナミックルーティング（独自実装）でルーティングテーブルを自動更新します。管理画面（Goのhtml/template＋Tailwind CDN）でルーターの追加・削除・ルーティング制御が可能です。

---

## システム構成
- 1つのGoプロセス内で複数の仮想ルーターをgoroutineとして管理
- 各ルーターはTUNデバイスを持ち、独立したIPアドレス/ルーティングテーブルを持つ
- ルーター間は仮想リンク（Goチャネル）で接続
- OSPF風のダイナミックルーティング（LSA交換・Dijkstra法）
- 管理画面でルーターの追加・削除・ルーティング制御

## 主要機能
- ルーターの追加・削除（TUNデバイス作成/削除、goroutine起動/停止）
- ルーター間リンクの追加・削除（仮想リンクの動的管理）
- 静的/動的ルーティング（OSPF風）
- パケット転送（TUNデバイス⇔ルーター間チャネル）
- 管理画面（ルーター一覧、詳細、追加・削除、ルーティング制御UI）

## ディレクトリ構成（予定）
```
day44_virtual_router/
├── main.go                # エントリポイント
├── router/                # 仮想ルーター本体
│   ├── router.go
│   ├── tun.go
│   ├── ospf.go
│   └── packet.go
├── web/                   # 管理画面
│   ├── handler.go
│   ├── templates/
│   │   ├── layout.html
│   │   ├── index.html
│   │   └── router_detail.html
│   └── static/
│       └── tailwind.min.css (CDN利用)
├── internal/              # 補助ライブラリ
│   └── util.go
├── go.mod
├── go.sum
└── README.md
```

## 主要技術
- Go 1.21+
- TUNデバイス制御: github.com/songgao/water など
- テンプレート: html/template
- スタイル: Tailwind CSS（CDN）
- ルーティング: 独自実装（OSPF風）
- Webサーバ: net/http

## 学べること
- TUNデバイスを用いた仮想ネットワークインターフェースの制御
- goroutine/チャネルによる並行ネットワーク処理
- OSPFの基本原理（LSA, Dijkstra法による経路計算）の実装
- Goの標準Webサーバ＋テンプレートによる管理画面構築
- Goでの動的なプロセス・リソース管理

## 制約・注意事項
- サーバは1台のみ、全ルーターはgoroutineで管理
- TUNデバイスの作成にはroot権限が必要な場合あり
- OSPFは本家完全準拠ではなく、学習用の簡易実装
- パケットはIPv4のみ対応
- 管理画面は日本語UI

## 詳細作業手順

### 0. 仕様・設計確定
- 要件・仕様の最終確認
- ディレクトリ構成・主要ファイル一覧の確定
- ルーター/リンク/パケット/OSPFのデータ構造設計
- 管理画面の画面遷移・UI設計

### 1. プロジェクト初期化
1.1 テンプレートディレクトリから `day44_virtual_router` を作成  
1.2 `package.json` の name を `day44_virtual_router` に変更  
1.3 `README.md` に本仕様を記載  
1.4 `PROGRESS.md` を作成し、作業工程を記載  
1.5 Goモジュール初期化（`go mod init`）  
1.6 必要な外部パッケージ（TUN制御用など）をインストール  
1.7 最低限のmain.goとディレクトリを作成

### 2. データモデリング・基盤実装
2.1 ルーター、リンク、パケット、OSPF LSAなどの構造体定義  
2.2 ルーター管理用のマネージャ構造体・マップの実装  
2.3 goroutineでルーターを動的に生成・管理する仕組みの実装  
2.4 仮想リンク（Goチャネル）によるルーター間通信の基盤実装  
2.5 テストコードでルーター生成・削除・リンク接続の動作確認  
2.6 コミット（step 2/xx）

### 3. TUNデバイス制御
3.1 TUNデバイスの作成・削除処理の実装  
3.2 TUNデバイスからのパケット受信・送信処理の実装  
3.3 ルーターgoroutineとTUNデバイスの連携  
3.4 テスト（TUNデバイス作成・削除、パケット送受信の確認）  
3.5 コミット（step 3/xx）

### 4. ルーター間パケット転送
4.1 ルーティングテーブルの初期実装（静的ルート）  
4.2 ルーター間でパケットをGoチャネル経由で転送する処理の実装  
4.3 ルーティングテーブルに従ったパケット転送ロジックの実装  
4.4 テスト（ルーター間でping相当のパケットが届くか確認）  
4.5 コミット（step 4/xx）

### 5. OSPF風ダイナミックルーティング
5.1 LSA（リンク状態アドバタイズメント）構造体・伝播処理の実装  
5.2 ルーターが定期的にLSAを生成・隣接ルーターに送信する処理  
5.3 LSAをもとにDijkstra法でルーティングテーブルを自動生成  
5.4 ルーティングテーブルの自動更新・反映処理  
5.5 テスト（ルーター追加/削除時にルーティングテーブルが自動更新されるか）  
5.6 コミット（step 5/xx）

### 6. 管理画面（Web UI）
6.1 Goのhtml/template＋Tailwind CDNで管理画面のベース作成  
6.2 ルーター一覧・詳細・追加・削除UIの実装  
6.3 ルーティング制御（静的/動的切替、再計算ボタン）のUI実装  
6.4 ルーター状態・ルーティングテーブル・リンク状態の可視化  
6.5 Web API（ルーター追加/削除/状態取得/ルーティング制御）実装  
6.6 テスト（UIからルーター操作、状態反映の確認）  
6.7 コミット（step 6/xx）

### 7. デバッグ・テスト
7.1 主要な操作フローの統合テスト（ルーター追加→リンク接続→パケット転送→ルーティング自動更新）  
7.2 エラーハンドリング・ログ出力の確認  
7.3 不要なファイル・コードの削除  
7.4 コミット（step 7/xx）

### 8. ドキュメント・仕上げ
8.1 READMEの最終更新（使い方・設計・注意点）  
8.2 .cursor/rules/knowledge.mdc の更新  
8.3 PROGRESS.md の完了チェック  
8.4 コミット（step 8/xx）

---

各ステップごとにテスト・コミット・PROGRESS.md更新を徹底すること。
