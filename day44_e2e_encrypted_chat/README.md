# Day44 - E2E暗号化チャット (ニューモーフィズムデザイン)

## 概要

本アプリケーションは、1対1のエンドツーエンド（E2E）暗号化チャット機能を提供するWebアプリケーションです。ユーザーはブラウザ上で動的にRSAキーペア（暗号化用・署名用）を生成し、秘密鍵は安全にローカルストレージに、公開鍵はサーバーデータベースに保存されます。

メッセージの送受信においては、ハイブリッド暗号方式を採用しています。具体的には、各メッセージに対して一時的な共通鍵（AES-GCM）を生成し、この共通鍵でメッセージ本文を暗号化します。その後、生成した共通鍵を受信者のRSA公開鍵（RSA-OAEP）で暗号化します。さらに、送信者はメッセージ全体（暗号化された共通鍵、初期化ベクトル、暗号化されたメッセージ本文）に対してRSA-PSSを用いてデジタル署名を行い、メッセージの完全性と送信者の認証を保証します。

デザインにはニューモーフィズムのトレンドを取り入れ、モダンで直感的なユーザーインターフェースを目指しました。

特筆すべき機能として、「メッセージ暗号化詳細と復号試行」機能を搭載しています。これにより、ユーザーは各メッセージの暗号化されたデータ（共通鍵、IV、本文、署名）を確認できるだけでなく、意図された受信者以外のユーザーとして共通鍵の復号を試みることができます。この機能を通じて、E2E暗号化によってメッセージが指定された相手以外には解読できないことを体験的に理解できます。

## 主な機能

-   **ユーザー登録と鍵管理:**
    -   任意のユーザー名で登録可能。
    -   登録時にブラウザ内でRSAキーペア（暗号化用、署名用）を動的に生成。
    -   秘密鍵はユーザーのローカルストレージに保存。
    -   公開鍵はサーバーのデータベースに保存。
-   **ユーザー選択とチャット相手選択:**
    -   登録済みユーザーリストから自分のアカウントを選択してログイン。
    -   会話したい相手を登録済みユーザーリストから選択。
-   **E2E暗号化メッセージ送受信:**
    -   メッセージ本文のAES-GCMによる暗号化・復号。
    -   AES共通鍵のRSA-OAEPによる暗号化・復号。
    -   メッセージ全体のRSA-PSSによる署名・検証。
-   **メッセージ表示:**
    -   メッセージは5秒ごとのポーリングにより自動更新。
    -   自分のメッセージと相手のメッセージを左右に分けて表示。
-   **E2E暗号化検証機能:**
    -   各メッセージの詳細（暗号化された共通鍵、IV、暗号化本文、署名）を表示。
    -   選択したメッセージに対し、チャットの当事者以外の第三者のユーザーとして、暗号化された共通鍵の復号を試行。
    -   復号が期待通り失敗することを確認することで、E2E暗号化の堅牢性を視覚的に体験。

## デザインコンセプト

-   **ニューモーフィズム (Neumorphism):**
    -   UI要素が背景から押し出されたり、凹んだりしているように見せるデザインスタイル。
    -   ソフトなシャドウとハイライトを使い、ミニマルで触感的なインターフェースを提供。

## 使用技術

-   **フレームワーク:** Next.js (App Router)
-   **言語:** TypeScript
-   **スタイリング:** Tailwind CSS (ニューモーフィズムスタイル適用)
-   **データベース:** SQLite (better-sqlite3 を使用)
-   **暗号処理:** Web Crypto API (RSA-OAEP, RSA-PSS, AES-GCM)

## ディレクトリ構造 (主要部分)

```
/day44_e2e_encrypted_chat
├── app/
│   ├── api/
│   │   ├── messages/       # メッセージ関連API
│   │   │   └── route.ts
│   │   └── users/          # ユーザー関連API
│   │       ├── [userId]/
│   │       │   └── route.ts
│   │       └── route.ts
│   ├── _lib/
│   │   └── crypto.ts       # 暗号処理関連ユーティリティ
│   ├── chat/
│   │   └── page.tsx        # チャットページのUIとロジック
│   ├── globals.css
│   └── layout.tsx
├── lib/
│   └── db.ts               # DB接続とスキーマ初期化
├── public/
├── tests/
│   └── chat.e2e.spec.ts    # Playwright E2Eテスト
├── package.json
└── README.md
```

## セットアップと起動方法

1.  リポジトリのルートディレクトリにいることを確認します。
2.  `day44_e2e_encrypted_chat` ディレクトリに必要なパッケージをインストールします (初回のみ)。
    ```bash
    cd day44_e2e_encrypted_chat
    npm install
    ```
3.  開発サーバーを起動します。
    ```bash
    npm run dev
    ```
    (サーバーは `http://localhost:3001` で起動します)
4.  ブラウザで `http://localhost:3001/chat` を開きます。

## APIエンドポイント概要

-   `GET /api/users`: 全ユーザーリストを取得
-   `POST /api/users`: 新規ユーザーを登録 (ユーザー名のみ)
-   `PUT /api/users/:userId`: 指定したユーザーの公開鍵を更新
-   `GET /api/messages?userId1=<ID1>&userId2=<ID2>`: 指定した二者間のメッセージを取得
-   `POST /api/messages`: 新規メッセージを送信 (暗号化データと署名を含む)

## 使い方

1.  **ユーザー登録:**
    *   チャットページ上部の「アカウント管理」セクションで、任意の「新しいユーザー名」を入力し、「登録 & 鍵生成」ボタンをクリックします。
    *   これにより、キーペアが生成され、秘密鍵がローカルストレージに、公開鍵がサーバーに保存されます。
2.  **自分のアカウント選択:**
    *   「あなたのアカウント」ドロップダウンから、先ほど登録した（または以前登録した）ユーザー名を選択します。
3.  **会話相手の選択:**
    *   「会話する相手」ドロップダウンから、チャットしたい相手を選択します。相手も事前にユーザー登録と鍵設定が済んでいる必要があります。
4.  **メッセージ送信:**
    *   相手を選択すると、メッセージ入力欄が表示されます。メッセージを入力し、「送信」ボタンをクリックします。
    *   メッセージはE2E暗号化および署名されて送信されます。
5.  **メッセージ確認とE2E検証:**
    *   送信したメッセージや受信したメッセージがチャット欄に表示されます。
    *   各メッセージの横にある「詳細」ボタンをクリックするとモーダルが開き、暗号化されたデータ（共通鍵、IV、本文、署名）が表示されます。
    *   モーダル内では、ドロップダウンから第三者のユーザーを選択し、「(選択ユーザー) として復号試行」ボタンをクリックできます。
    *   これにより、メッセージの共通鍵が意図された受信者以外には復号できないことが確認できます。

---

&copy; 2025 100day_challenge_backend Project by lirlia
