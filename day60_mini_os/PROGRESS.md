# Day60 - Mini OS Implementation Progress

## プロジェクト概要
QEMUで動作する独自OSを実装する。スケジューラ、仮想メモリ、独自シェル（echo/ls対応）を含む。

## 技術スタック
- **言語**: C言語 + inline assembly (x86-32bit)
- **エミュレータ**: QEMU
- **ビルド**: Makefile + GCC cross-compiler (x86_64-elf-gcc)
- **確認方法**: QEMUシリアル出力をファイル保存 → read_file で確認
- **メモリ管理**: ビットマップベースのページフレームアロケータ

## 作業工程

### Phase 1: 開発環境構築 ✅
- [x] プロジェクト初期化
- [x] クロスコンパイラ確認・設定
- [x] Makefile 作成
- [x] 基本ディレクトリ構造作成

### Phase 2: ブートローダー & 基本カーネル ✅
- [x] 最小限ブートローダー実装 (boot.asm)
- [x] カーネルエントリポイント実装 (kernel.c)
- [x] シリアルポート出力機能実装
- [x] 初回ビルド & QEMU起動テスト
- [x] "Hello, OS!" 出力確認 (シンプルブートローダーで成功)

### Phase 3: メモリ管理 (物理) ✅
- [x] メモリマップ取得・解析 (Multiboot情報 + フォールバック256MB)
- [x] 物理メモリ管理機構実装 (ページフレームアロケータ)
- [x] ビットマップベース メモリ追跡システム
- [x] ページ割り当て・解放機能 (alloc_page/free_page)
- [x] カーネルページ保護機能
- [x] メモリ情報デバッグ出力
- [x] メモリ確保/解放テスト (**3ページ割り当て→1ページ解放→再割り当て成功**)

### Phase 4: プロセス管理 & スケジューラ ✅
- [x] プロセス制御ブロック（PCB）定義
- [x] プロセス状態管理 (READY, RUNNING, BLOCKED)
- [x] コンテキストスイッチ実装 (レジスタ保存/復元)
- [x] プロセススケジューラ（Round Robin）
- [x] プロセス作成機能（カーネルスレッド）
- [x] マルチプロセス動作確認
- [x] プロセス一覧表示機能

### Phase 5: 割り込み処理
- [ ] IDT（割り込み記述子テーブル）設定
- [ ] 基本的な例外ハンドラ
- [ ] タイマー割り込み設定 (PIT: Programmable Interval Timer)
- [ ] システムコール割り込み（int 0x80）
- [ ] 割り込みハンドラテスト

### Phase 6: 仮想メモリ (ページング)
- [ ] ページテーブル構造体定義
- [ ] ページディレクトリ初期化
- [ ] 仮想アドレス → 物理アドレス変換
- [ ] ページフォルト処理（基本）
- [ ] 仮想メモリマッピング確認

### Phase 7: システムコール
- [ ] システムコールインターフェース設計
- [ ] 基本システムコール実装：
  - [ ] sys_write（コンソール出力）
  - [ ] sys_read（キーボード入力）
  - [ ] sys_fork（プロセス生成）
  - [ ] sys_exec（プログラム実行）
  - [ ] sys_exit（プロセス終了）
- [ ] システムコール動作テスト

### Phase 8: ユーザーランド基盤
- [ ] ユーザー空間プロセス実行環境
- [ ] ELF形式プログラム読み込み（簡易版）
- [ ] ユーザープロセス起動テスト
- [ ] 権限分離確認（kernel space / user space）

### Phase 9: 基本ファイルシステム
- [ ] 仮想ファイルシステム設計
- [ ] ルートディレクトリ構造作成
- [ ] 基本ファイル操作API
- [ ] ディレクトリリスト機能
- [ ] ファイル操作テスト

### Phase 10: シェル実装
- [ ] シェルプロセス実装
- [ ] コマンドライン解析
- [ ] プロセス起動機能
- [ ] 入出力リダイレクト（基本）
- [ ] シェル対話テスト

### Phase 11: 基本コマンド実装
- [ ] echo コマンド実装
- [ ] ls コマンド実装
- [ ] cat コマンド実装（ボーナス）
- [ ] ps コマンド実装（プロセス一覧）
- [ ] 全コマンド動作確認

### Phase 12: 統合テスト & 最適化
- [ ] 全機能統合テスト
- [ ] パフォーマンステスト
- [ ] メモリリーク検証
- [ ] エラーハンドリング強化
- [ ] ドキュメント作成

## 現在の成果 (Phase 4完了時点)

### **メモリ管理システム**
- **総メモリ**: 256MB (65536ページ, 4KBページサイズ)
- **カーネルサイズ**: 68KB (ページ256-273を占有)
- **ビットマップ**: 8192バイト (2048 u32要素)
- **動作確認**: ページ割り当て・解放・再利用サイクル成功

### **プロセス管理システム**
- **プロセス数**: 2個（idle, test_a）
- **スタック**: 各プロセス8KB
- **PID管理**: 正常動作（PID 1, 2割り当て済み）
- **プロセス作成**: 正常動作
- **プロセス実行**: 直接関数呼び出しで動作確認済み

### **技術的解決事項**
- ✅ 64bit→32bit アーキテクチャ変換
- ✅ `%x`フォーマット指定子バグ修正
- ✅ Multiboot引数問題解決 (引数なしkmain採用)
- ✅ 32KBスタック確保による安定化
- ✅ コンテキストスイッチアセンブリバグ修正
- ✅ プロセス管理とメモリ管理の統合

## ファイル構成 (現在)

```
day60_mini_os/
├── src/
│   ├── boot/
│   │   └── multiboot_kernel.asm  # Multibootエントリ + 32KBスタック
│   ├── kernel/
│   │   ├── main.c                # カーネルメイン + テスト
│   │   ├── memory.c              # 物理メモリ管理 ✅
│   │   └── string.c              # 文字列操作
│   ├── drivers/
│   │   └── serial.c              # シリアル出力
│   └── include/
│       ├── kernel.h              # カーネル共通
│       └── memory.h              # メモリ管理API
├── build/                        # ビルド出力
├── Makefile                      # 32bit x86ビルド設定
├── linker.ld                     # メモリレイアウト
└── PROGRESS.md                   # 進捗管理
```

## 各フェーズのテスト方法

1. **ビルドテスト**: `make clean && make`
2. **実行テスト**: `qemu-system-x86_64 -kernel build/kernel.bin -serial stdio`
3. **メモリテスト**: alloc_page/free_page サイクル確認
4. **機能テスト**: 各フェーズごとに特定機能の動作確認

## 学習ポイント

- **低レベルプログラミング**: アセンブリ、メモリ直接操作
- **OS理論実践**: プロセス、メモリ、スケジューリング
- **ハードウェア制御**: 割り込み、デバイスドライバ
- **システムプログラミング**: カーネル空間とユーザー空間の分離
- **デバッグ技術**: QEMUデバッガ、シリアル出力ログ
- **メモリ管理**: ビットマップアルゴリズム、ページアライメント
