## Day53: CPU対戦付き二人麻雀 (最強AI) - 進捗

### Project Progress

- [x] **Step 1: Project Initialization**
    - [x] Copy `template` to `day53_mahjong_ai`.
    - [x] Update `package.json` (name: `day53_mahjong_ai`).
    - [x] Update `README.md` with project plan.
    - [x] Create and update `PROGRESS.md`.
    - [x] Create basic `app/layout.tsx` and `app/page.tsx`.
    - [x] Update `app/globals.css` for Tailwind v4 and Claymorphism basics.
    - [x] Fix Linter errors (reinstall `node_modules`).
    - [x] Start dev server: `npm run dev -- --port 3001`.
- [x] **Step 2: Mahjong Core Logic (Tiles & Yama)** (`lib/mahjong/tiles.ts`, `lib/mahjong/yama.ts`)
    - [x] Define tile suits, honor types, `Tile` interface, all 34 tile prototypes.
    - [x] Implement utility functions (`compareTiles`, `tileFromString`, `tilesToStrings`, `isSameTile`).
    - [x] Implement `Yama` interface, `createYama` (136 tiles, shuffled, Wanpai, Dora indicator).
    - [x] Implement `dealInitialHands`, `drawTile`, `drawRinshanTile`, `getDoraFromIndicator`, `getCurrentDora`.
    - [x] Test with `test-mahjong-core.ts` (deleted after use).
- [x] **Step 3: Mahjong Core Logic (Hand & Shanten)** (`lib/mahjong/hand.ts`)
    - [x] Implement hand management (`addTileToHand`, `removeTileFromHand`, `countTiles`)
    - [x] Implement basic win condition checks (`isBasicAgari`, `isChiitoitsu`, `isKokushiMusou`)
    - [x] Implement simplified Shanten calculation (`analyzeHandShanten`) for win, Kokushi tenpai, Chiitoi tenpai, and basic 13-tile tenpai.
    - [x] Test with `test-mahjong-hand.ts` (deleted after use).
- [x] **Step 4: API Implementation (Game Start & Basic Actions)**
    - [x] Define game state (`lib/mahjong/game_state.ts`: `PlayerID`, `GamePhase`, `PlayerState`, `GameState`, `createInitialGameState`).
    - [x] Create `/api/game/new` (GET) endpoint: initialize game, yama, hands, dora, store in-memory.
    - [x] Create `/api/game/action` (POST) endpoint: handle player `discard`, basic CPU turn (draw & random discard), player's next draw, update state.
    - [x] Implement shared in-memory game store (`lib/mahjong/game_store.ts`).
    - [x] Test `/api/game/new` and `/api/game/action` with `curl`.
    - [x] `lib/mahjong/game_state.ts`: `ActionType` enum, `KanPossibility`, `GameAction`, `TileInRiver` interfaces. `PlayerState` に `isRiichi`, `riichiTileIndex`, `riichiTurn`, アクション可能フラグ, `possibleKans`, `justKaned`, `lastDraw`, `lastDiscard` を追加. `GameState` に `turn`, `wind`, `round`, `honba`, `riichiSticks`, `dora`, `uraDora`, `winner`, `gameWinner`, `winningHandInfo`, `lastAction`, `lastActionMessage`, `turnCount`, `kanCount`, `totalRounds` を追加。
    - [x] `lib/mahjong/game_state.ts`: `createInitialGameState` で九種九牌の初期判定と処理、親の最初のツモ牌とアクションフラグ更新を実装。
    - [x] `lib/mahjong/game_state.ts`: `updateActionFlagsForPlayer` で手牌分析とアクション可能フラグ（ツモ和了、ロン、リーチ、カン、ポン）の更新ロジックを実装。
    - [x] `lib/mahjong/game_state.ts`: `proceedToNextRoundOrEndGame` で連荘判定、規定局数終了判定、次局準備を実装。
    - [x] `lib/mahjong/game_state.ts`: `processAction` で `Discard`, `Riichi`, `TsumoAgari`, `Ron`, `Kan`, `Pon` の各アクション処理を実装。
- [x] **Step 5: UI Implementation (Basic Game Screen)**
    - [x] Create main React component for the Mahjong table (`app/page.tsx`).
    - [x] Style components using Tailwind CSS with a Claymorphism theme (`globals.css`, `page.tsx`).
    - [x] Fetch initial game state from `/api/game/new` on page load.
    - [x] Implement player tile discard action (calls `/api/game/action`).
    - [x] Create sub-components:
        - [x] Tile display component (`day53_mahjong_ai/components/mahjong/TileDisplay.tsx`).
        - [x] Player's hand display component (`day53_mahjong_ai/components/mahjong/PlayerHand.tsx`).
        - [x] Integrate `PlayerHand` and `TileDisplay` into `app/page.tsx`.
    - [x] CPU's hand display (tiles face down, count visible) in `app/page.tsx`.
    - [x] Player's river (discarded tiles) display in `app/page.tsx`.
    - [x] CPU's river display in `app/page.tsx`.
    - [x] Dora indicator display in `app/page.tsx`.
    - [x] Yama (deck) display (remaining tile count) in `app/page.tsx`.
    - [x] Scoreboard / Game info display (current turn, round, player scores) in `app/page.tsx`.
    - [x] Action buttons (Discard, Riichi, TsumoAgari, Kan, Ron) and handlers in `app/page.tsx`.
    - [x] Linterエラーを修正。
- [x] **Step 6: Mahjong Core Logic (Score Calculation & Yaku)**
    - [x] Implement basic score calculation logic (`lib/mahjong/score.ts`).
    - [x] Implement yaku detection functions (`lib/mahjong/yaku.ts`): Riichi, Tsumo, Pinfu, Tanyao, Yakuhai (Ton, Nan, Sha, Pei, Haku, Hatsu, Chun), Iipeikou, SanshokuDoujun, Ikkitsuukan.
    - [x] Implement Fu calculation logic (`lib/mahjong/fu.ts`).
    - [x] Integrate score calculation into `processAction` (TsumoAgari, Ron).
    - [x] Test score calculation and yaku detection.
    - [x] Refine `determineMachiPattern` in `hand.ts`.
    - [x] Add `isYaochuuhai` to `tiles.ts`.
    - [x] Fix Linter errors in `game_state.ts` related to score calculation options and `agariTile` type issues.
- [x] **Step 7: Advanced Game Flow & CPU AI**
    - [x] Implement basic CPU AI for discards (shanten-based) and simple decisions (`lib/mahjong/cpu_player.ts`).
    - [x] `lib/mahjong/cpu_player.ts`: Added `evaluateDiscardOptions` helper. Improved discard logic (shanten-based with Riichi consideration). Improved Pon decision logic (for Yakuhai and shanten advance).
    - [x] `lib/mahjong/game_state.ts`: Added `seatWind` to `PlayerState` and updated `wind` in `GameState` to `HonorType`. Initialized `seatWind` in `createInitialGameState` and `proceedToNextRoundOrEndGame`. Refined dealer and round progression logic in `proceedToNextRoundOrEndGame`.
    - [x] Integrate CPU AI into `game_state.ts` to enable automated CPU turns.
    - [x] **UI**: Changed tile discard to be immediate on click, removing the confirmation step (`app/page.tsx`).
    - [ ] Implement CPU AI for Riichi decisions (advanced: considering wait shape, dora, remaining tiles).
    - [ ] Implement CPU AI for Kan decisions (Ankan, Kakan, Daiminkan - more sophisticated risk/reward).
    - [ ] Implement CPU AI for Pon decisions.
    - [ ] **UI**: Reverted immediate discard on tile click. Implemented tile selection first, then action via buttons (Discard, Riichi) (`app/page.tsx`).
    - [ ] **BugFix**: Enabled tile selection after Kan and Rinshan kaihou tsumo by removing hand length restrictions in `handleTileSelect` (`app/page.tsx`).
    - [ ] **Bug Investigation**: Investigating issue where player's hand does not correctly update視覚上or reflect drawn tile after a normal tsumo. Added detailed console logging. (Ongoing)
    - [ ] Implement complex yaku calculations (e.g., Chanta, Junchan, Honroutou, Chinitsu, Honitsu).
    - [ ] Implement Ryanhan shibari (two-han minimum for winning) if game continues to many honba.
    - [ ] Handle complex game scenarios (e.g., multiple players can Ron, head bump - 2 player so simpler).
    - [ ] Implement Chankan yaku logic.
    - [ ] Implement Rinshan Kaihou yaku logic (partially done, needs full integration and testing).
    - [ ] Implement Haitei/Houtei Raoyui yaku logic.
    - [ ] Implement Tenhou/Chihou yaku logic (if applicable for 2-player).
    - [ ] Handle draws (Kyuushuu Kyuuhai, Suukaikan already done, Sanchahou, Suufon Renda, if applicable).
    - [x] Resolve remaining Linter errors in `game_state.ts`.
- [ ] **Step 8: Final Touches & Documentation**
    - [ ] Implement Ura-dora logic (partially done, needs full display and integration).
    - [ ] Display winning hand details (yaku, fu, score breakdown).
    - [ ] UI Polish: animations for tile discard/draw, sound effects (optional), better visual feedback.
    - [ ] Comprehensive testing (manual and automated if possible with Playwright).
    - [ ] Update `README.md` with full game instructions and features.
    - [ ] Update `.cursor/rules/knowledge.mdc`.

以下に進捗を記載してください。


- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 

## Step 8: 仕上げとドキュメント (進行中)

-   [x] **ゲーム終了ロジックと表示:**
    -   [x] `game_state.ts`: `GameState` に `winner`, `winningHandInfo`, `finalScores`, `totalRounds`, `gameWinner` を追加。`GamePhase` に `GameOver` を追加。和了/流局/規定局数終了時にこれらを設定する `proceedToNextRoundOrEndGame` を実装し、`processAction` に統合。
    -   [x] `components/game-result-modal.tsx`: ゲーム結果（勝者、手牌、役、点数、最終スコア）を表示するモーダルを `GameOver` フェーズに対応。
    -   [x] `app/page.tsx`: `GameResultModal` を統合し、`gameState.phase` が `PlayerWon`, `CPUWon`, `Draw`, `GameOver` の場合に表示。総局数も表示。
-   [x] **カン処理改善 (UI):**
    -   [x] `game_state.ts`: `updateActionFlagsForPlayer` でリーチ後の暗槓・加槓を一旦不可とするシンプルなルールに変更。
    -   [x] `app/page.tsx`: 「カン」ボタン押下で可能な暗槓・加槓のリストをモーダル表示し、選択して実行できるようにUIを改善。
-   [x] **裏ドラと嶺上開花:** (一部実装済み、確認と調整)
    -   [x] `yama.ts`: `Yama` インターフェースに `uraDoraIndicators` を追加。`createYama` で初期化。`getCurrentUraDora` 関数を確認。
    -   [x] `game_state.ts`: `PlayerState` に `justKaned` フラグを追加。`GameState` に `uraDora` フィールドを追加。`processAction` でカン後に `justKaned` を設定し、打牌でクリア。和了時に `analyzeHandShanten`
