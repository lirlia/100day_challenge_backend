## Day53: CPU対戦付き二人麻雀 (最強AI) - 進捗

### Project Progress

- [x] **Step 1: Project Initialization**
    - [x] Copy `template` to `day53_mahjong_ai`.
    - [x] Update `package.json` (name: `day53_mahjong_ai`).
    - [x] Update `README.md` with project plan.
    - [x] Create and update `PROGRESS.md`.
    - [x] Create basic `app/layout.tsx` and `app/page.tsx`.
    - [x] Update `app/globals.css` for Tailwind v4 and Claymorphism basics.
    - [x] Fix Linter errors (reinstall `node_modules`).
    - [x] Start dev server: `npm run dev -- --port 3001`.
- [x] **Step 2: Mahjong Core Logic (Tiles & Yama)** (`lib/mahjong/tiles.ts`, `lib/mahjong/yama.ts`)
    - [x] Define tile suits, honor types, `Tile` interface, all 34 tile prototypes.
    - [x] Implement utility functions (`compareTiles`, `tileFromString`, `tilesToStrings`, `isSameTile`).
    - [x] Implement `Yama` interface, `createYama` (136 tiles, shuffled, Wanpai, Dora indicator).
    - [x] Implement `dealInitialHands`, `drawTile`, `drawRinshanTile`, `getDoraFromIndicator`, `getCurrentDora`.
    - [x] Test with `test-mahjong-core.ts` (deleted after use).
- [x] **Step 3: Mahjong Core Logic (Hand & Shanten)** (`lib/mahjong/hand.ts`)
    - [x] Implement hand management (`addTileToHand`, `removeTileFromHand`, `countTiles`)
    - [x] Implement basic win condition checks (`isBasicAgari`, `isChiitoitsu`, `isKokushiMusou`)
    - [x] Implement simplified Shanten calculation (`analyzeHandShanten`) for win, Kokushi tenpai, Chiitoi tenpai, and basic 13-tile tenpai.
    - [x] Test with `test-mahjong-hand.ts` (deleted after use).
- [x] **Step 4: API Implementation (Game Start & Basic Actions)**
    - [x] Define game state (`lib/mahjong/game_state.ts`: `PlayerID`, `GamePhase`, `PlayerState`, `GameState`, `createInitialGameState`).
    - [x] Create `/api/game/new` (GET) endpoint: initialize game, yama, hands, dora, store in-memory.
    - [x] Create `/api/game/action` (POST) endpoint: handle player `discard`, basic CPU turn (draw & random discard), player's next draw, update state.
    - [x] Implement shared in-memory game store (`lib/mahjong/game_store.ts`).
    - [x] Test `/api/game/new` and `/api/game/action` with `curl`.
    - [x] Integrate and test core Yaku/Score logic (`yaku.ts`, `score.ts`) via `analyzeHandShanten` in `hand.ts` using `hand.test.ts`.
- [x] **Step 5: UI Implementation (Basic Game Screen)**
    - [x] Create main React component for the Mahjong table (`app/page.tsx`).
    - [x] Style components using Tailwind CSS with a Claymorphism theme (`globals.css`, `page.tsx`).
    - [x] Fetch initial game state from `/api/game/new` on page load.
    - [x] Implement player tile discard action (calls `/api/game/action`).
    - [x] Create sub-components:
        - [x] Tile component (`components/tile-display.tsx`).
        - [x] Player's hand display (in `page.tsx`).
        - [x] CPU's (opponent's) hand display (tiles face down, count visible) (in `page.tsx`).
        - [x] Player's river (discarded tiles) (in `page.tsx`).
        - [x] CPU's river (in `page.tsx`).
        - [x] Dora indicator display (in `page.tsx`).
        - [x] Yama (deck) display (remaining tile count) (in `page.tsx`).
        - [x] Scoreboard / Game info display (current turn, round, player scores) (in `page.tsx`).
        - [x] Action buttons (Discard, Riichi, Tsumo, Kan) (in `page.tsx`).
- [x] **Step 6: Mahjong Core Logic (Yaku & Score - Refinement)**
    - [x] `lib/mahjong/yaku.ts`: 平和(Pinfu)の判定ロジックを追加
    - [x] `lib/mahjong/yaku.ts`: 一盃口(Iipeikou)の判定ロジックを追加
    - [x] `lib/mahjong/hand.test.ts`: 平和と一盃口のテストケースを追加・パス
    - [x] `lib/mahjong/yaku.ts`: 三色同順(Sanshoku Doujun)の判定ロジックを追加
    - [x] `lib/mahjong/yaku.ts`: 一気通貫(Ikkitsuukan)の判定ロジックを追加
    - [x] `lib/mahjong/hand.test.ts`: 三色同順と一気通貫のテストケースを追加
    - [x] `lib/mahjong/hand.ts`: `analyzeHandShanten`, `isBasicAgari`, `extractMeldsAndJantou` を修正し、鳴き面子を考慮
    - [x] `lib/mahjong/hand.test.ts`: 全テストケースの `handTiles` をアガリ牌を含まない枚数に修正
    - [x] `lib/mahjong/yaku.ts`: デバッグログを削除
    - [x] `lib/mahjong/hand.test.ts`: 「役牌(白)のみ」テストケースの手牌を修正し、全テストケースがパス
- [x] **Step 7: UI/UX & Game Flow Refinement (Actions & CPU)**
    - [x] `components/tile-display.tsx`: Created and enhanced TileDisplay component.
    - [x] `app/page.tsx`: Integrated new TileDisplay, added action buttons (Riichi, Kan, TsumoAgari, Ron) and handlers.
    - [x] `lib/mahjong/game_state.ts`: Defined `ActionType`, `GameAction`. Updated `PlayerState` (action flags), `GameState` (more properties). Implemented `createInitialGameState` with first player draw and initial action flags.
    - [x] `lib/mahjong/game_state.ts`: Implemented `processAction` to handle Discard, Riichi, TsumoAgari, Ron, Kan (Ankan basic) with state updates and action flag refresh via `updateActionFlagsForPlayer`.
    - [x] `lib/mahjong/game_state.ts`: `updateActionFlagsForPlayer` now detects Ankan possibility.
    - [x] `app/api/game/action/route.ts`: Refactored to use `processAction`. Improved CPU discard logic (simple heuristic).
    - [x] Corrected Linter errors across multiple files related to type definitions and imports.
- [ ] **Step 8: Final Touches & Documentation**
    - [ ] Implement Kan-dora logic.
    - [ ] Implement score calculation and display for Tsumo/Ron.
    - [ ] Implement logic for Ura-dora and Rinshan Kaihou yaku.
    - [ ] Further enhance CPU AI (meld decisions, Riichi decisions, more advanced discard).
    - [ ] Implement game end conditions (e.g., player bankruptcy, round limits) and display.
    - [ ] UI Polish: Agari/Ryukyoku result display, better error handling, overall design refinements.
    - [ ] Comprehensive testing (including Playwright for E2E if time permits).
    - [ ] Update `README.md` with final app description and how to play.
    - [ ] Update `.cursor/rules/knowledge.mdc`.

以下に進捗を記載してください。


- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 

## Step 8: 仕上げとドキュメント (進行中)

-   [x] **ゲーム終了ロジックと表示:**
    -   [x] `game_state.ts`: `GameState` に `winner`, `winningHandInfo`, `finalScores`, `totalRounds`, `gameWinner` を追加。`GamePhase` に `GameOver` を追加。和了/流局/規定局数終了時にこれらを設定する `proceedToNextRoundOrEndGame` を実装し、`processAction` に統合。
    -   [x] `components/game-result-modal.tsx`: ゲーム結果（勝者、手牌、役、点数、最終スコア）を表示するモーダルを `GameOver` フェーズに対応。
    -   [x] `app/page.tsx`: `GameResultModal` を統合し、`gameState.phase` が `PlayerWon`, `CPUWon`, `Draw`, `GameOver` の場合に表示。総局数も表示。
-   [x] **カン処理改善 (UI):**
    -   [x] `game_state.ts`: `updateActionFlagsForPlayer` でリーチ後の暗槓・加槓を一旦不可とするシンプルなルールに変更。
    -   [x] `app/page.tsx`: 「カン」ボタン押下で可能な暗槓・加槓のリストをモーダル表示し、選択して実行できるようにUIを改善。
-   [x] **裏ドラと嶺上開花:** (一部実装済み、確認と調整)
    -   [x] `yama.ts`: `Yama` インターフェースに `uraDoraIndicators` を追加。`createYama` で初期化。`getCurrentUraDora` 関数を確認。
    -   [x] `game_state.ts`: `PlayerState` に `justKaned` フラグを追加。`GameState` に `uraDora` フィールドを追加。`processAction` でカン後に `justKaned` を設定し、打牌でクリア。和了時に `analyzeHandShanten` の `agariContext` に `uraDoraTiles` と `isRinshan` を設定するロジックを確認。
    -   [x] `hand.ts`: `analyzeHandShanten` の `AgariContext` に `isRinshan?: boolean` を追加。`checkYaku` に渡す `HandContext` にも `isRinshan` を追加する部分を確認。
    -   [x] `yaku.ts`: `ALL_YAKU_DEFINITIONS` に `RinshanKaihou` を追加。`checkYaku` を更新し `isRinshan` をチェックする部分を確認。
    -   [x] 点数計算に裏ドラ・カンドラ・カン裏ドラが正しく反映されるか確認。
-   [x] **CPU AIと高度なゲームフロー:** (一部進行中)
    -   [x] CPUの打牌AIを改善 (向聴数を考慮した打牌選択を `app/api/game/action/route.ts` に実装。`game_state.ts` への本格的な移植は今後の課題)。
    -   [x] CPUのリーチ判断、カン判断（暗槓のみ仮実装、`game_state.ts` 内）。
    -   [x] CPUの鳴き判断（ポン）：`app/api/game/action/route.ts` に簡易的なポン実行ロジックを追加 (現在はポン可能なら常にポン)。
    -   [x] 流局（九種九牌）：`lib/mahjong/hand.ts` に判定関数 `isKyuushuuKyuuhai` を追加し、`lib/mahjong/game_state.ts` の初期配牌時と局開始時に九種九牌による流局処理を追加。
    -   [x] `lib/mahjong/game_state.ts`: ポン (`ActionType.Pon`) のロジックを `processAction` に追加。`updateActionFlagsForPlayer` に `canPon` 判定を追加。Linterエラーを修正。
    -   [x] `app/api/game/action/route.ts`: CPUの自動アクション実行ロジックを強化。
-   [ ] **その他仕上げ:**
    -   [ ] フリテンのチェックと表示 (警告など)。
    -   [ ] UI/UXの微調整 (ローディング表示、エラーメッセージ、牌のソートなど)。
-   [ ] Linterエラー (`game_state.ts` の型エラー) の最終確認と修正。
    -   [ ] 最終テスト (Playwright)。
-   [ ] **ドキュメント:**
    -   [ ] `README.md` の更新。
    -   [ ] `.cursor/rules/knowledge.mdc` の更新。
