# Day47: コンテンツ配信ネットワーク (CDN) シミュレータ

これは、コンテンツ配信ネットワーク (CDN) の基本的な動作原理をシミュレートするWebアプリケーションです。
ユーザーはオリジンサーバーにコンテンツを登録し、複数の設定可能なエッジサーバーを通じて、クライアント（シミュレートされたユーザー）からのリクエストに応じてコンテンツがどのように配信されるかを視覚的に確認できます。
キャッシュ戦略 (LRU, TTL) やリクエストルーティングの基本的な概念を学ぶことを目的とします。

**デザインテーマ:** ニューモーフィズム (Neumorphism)

## 主な機能とUIコンポーネント

本アプリケーションは以下の主要な機能を提供します。

1.  **オリジンコンテンツ管理 (`OriginContentsManager.tsx`)**
    *   オリジンサーバーにコンテンツを登録（コンテンツID、データ/URL、コンテントタイプ）。
    *   登録済みコンテンツの一覧表示と削除。

2.  **エッジサーバー設定 (`EdgeServerManager.tsx`)**
    *   エッジサーバーの追加（サーバーID、地域、キャッシュ容量、デフォルトTTL）。
    *   設定済みエッジサーバーの一覧表示と削除。

3.  **リクエストシミュレーション (`RequestSimulator.tsx`)**
    *   クライアントの地域とリクエストするコンテンツIDを選択。
    *   シミュレーションを実行し、結果（キャッシュヒット/ミス、配信元サーバー、退避されたアイテムなど）を表示。

4.  **配信プロセス視覚化 (`VisualizationLog.tsx`)**
    *   シミュレーションされたリクエストのログを時系列で表示。
    *   各ログには、リクエスト時刻、クライアント地域、コンテンツID、配信サーバー、キャッシュ状態、オリジンフェッチの有無が含まれます。

5.  **エッジサーバーキャッシュ状態表示 (`EdgeServerCacheView.tsx`)**
    *   各エッジサーバーの現在のキャッシュ内容を一覧表示。
    *   キャッシュされているアイテムのID、キャッシュ時刻、有効期限、最終アクセス時刻を確認可能。
    *   サーバーのキャッシュ使用量（現在のアイテム数 / 最大容量）も表示。

6.  **統計情報表示 (`StatsDisplay.tsx`)**
    *   CDN全体のパフォーマンス統計を表示。
    *   総リクエスト数、キャッシュヒット数、キャッシュヒット率。
    *   リージョン別リクエスト数、人気コンテンツ（上位10件）ランキング。
    *   統計情報は30秒ごとに自動更新。

## 技術スタック

- フレームワーク: Next.js 14 (App Router)
- 言語: TypeScript
- データベース: SQLite
- DBアクセス: better-sqlite3
- API実装: Next.js Route Handlers
- スタイリング: Tailwind CSS (Neumorphism デザインテーマ)
- 状態管理 (UI): React Hooks (`useState`, `useEffect`, `useCallback`)
- Lint & Format: Biome.js

## 起動方法

```bash
# 1. プロジェクトルートに移動
cd day47_cdn_simulator

# 2. 依存関係をインストール
npm install

# 3. 開発サーバーを起動 (ポート3001で起動します)
npm run dev
```

ブラウザで `http://localhost:3001/dashboard` にアクセスしてください。

## CDNコアロジック (`app/_lib/cdn-logic.ts`)

- **エッジサーバー選択:** クライアントのリージョンに一致するエッジサーバーを優先的に選択。一致しない場合はフォールバック（現在は最初に登録されたサーバー）。
- **キャッシュ管理:**
    - **TTL (Time-To-Live):** 各エッジサーバーで設定されたTTLに基づき、キャッシュアイテムは期限切れとなる。
    - **LRU (Least Recently Used):** キャッシュ容量が一杯の場合、最も長い間アクセスされていないアイテムが新しいアイテムのために退避される。
- **ログ記録:** 全てのリクエストとキャッシュの動作はデータベースの `request_logs` テーブルに記録される。

## データベーススキーマ (`lib/db.ts`)

- `origin_contents`: オリジンサーバーのコンテンツ情報。
- `edge_servers`: エッジサーバーの設定情報（地域、容量、TTLなど）。
- `edge_cache_items`: 各エッジサーバーのキャッシュ内アイテム（LRUのための最終アクセス時刻、TTLのための有効期限も含む）。
- `request_logs`: シミュレートされた全リクエストのログ情報。

---

_このプロジェクトは学習目的で作成されており、実際のCDNの全ての複雑さを網羅しているわけではありません。_
