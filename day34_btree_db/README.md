# Day 34: Go による B+Tree ベースのデータベース実装

Go 言語を使用して、永続化機能を持つ B+Tree ベースのシンプルなリレーショナルデータベースエンジンを実装します。基本的な SQL 操作 (CREATE TABLE, INSERT, SELECT, DELETE) をサポートし、ディスクへの永続化を行います。

https://github.com/user-attachments/assets/9bc4fd59-833d-4354-ba40-5b700f7ad0dc

https://github.com/user-attachments/assets/3af0b7cb-1f85-489c-a346-053a831131b4

[100日チャレンジ day34](https://zenn.dev/gin_nazo/scraps/01e1684464871b)

## プロジェクト概要

このプロジェクトは、データベースシステムのコアコンポーネントを理解することを目的としています。主な機能は以下の通りです。

- **B+Tree 実装:** キー/バリュー ストアとして機能する B+Tree を実装。挿入、検索、削除、範囲スキャン操作をサポートし、ノードの分割・マージによるバランス調整を行います。
- **ディスク永続化:** B+Tree のノードやメタデータをディスク上のファイル (`.db` ファイル) に永続化します。ページ単位での読み書きを行うディスクマネージャーを実装します。
- **スキーマ管理:** テーブル定義（カラム名、データ型）を管理する機能を実装します。
- **SQL ライクな操作:**
    - `CREATE TABLE <table_name> (<col_name> <type>, ...)`
    - `INSERT INTO <table_name> (<col1>, <col2>) VALUES (<val1>, <val2>)`
    - `SELECT <col1>, <col2> FROM <table_name> WHERE <condition>` (基本的な等価条件)
    - `DELETE FROM <table_name> WHERE <condition>` (基本的な等価条件)
- **実行エンジン:** 簡単なパーサー（今回は実装せず、構造化されたコマンドを直接処理）と、B+Tree 操作を組み合わせたクエリ実行ロジックを実装します。
- **REPL (CLI):** `cmd/` ディレクトリに、データベースと対話するための基本的なコマンドラインインターフェースを実装します。

## 技術スタック

- **言語:** Go
- **データ構造:** B+Tree (自前実装)
- **永続化:** 標準ライブラリ (`os`, `encoding/binary`, `bufio`)
- **CLI:** 標準ライブラリ (`flag`, `fmt`, `bufio`)

## ディレクトリ構成 (主要部分)

```
/
├── btree_*.go            # B+Tree のコアロジック (挿入, 削除, 検索, スキャン, 再バランス)
├── node.go              # B+Tree のノード構造定義
├── disk_*.go            # ディスクマネージャー、ページ I/O
├── db.go                # データベース全体の管理、操作の起点
├── schema.go            # テーブルスキーマ定義
├── operations_*.go      # CRUD 操作のロジック
├── executor_*.go        # コマンド実行エンジン
├── cmd/                 # CLI アプリケーション
│   └── main.go
├── *.db                 # データベースファイル
└── go.mod, go.sum       # Go モジュール管理
```

## 学び

- B+Tree データ構造の詳細な実装（特に再バランス処理）。
- データベースにおけるディスク永続化の基本的な仕組み（ページング、ディスクマネージャー）。
- テーブルスキーマとデータの関連付け。
- SQL 操作が内部的にどのようにデータ構造操作に変換されるかの基礎。
- Go による低レベルなファイル I/O とバイナリデータの扱い。

## 1. 目的

このプロジェクトの目的は、リレーショナルデータベースマネジメントシステム (RDBMS) のコアコンポーネントであるストレージエンジン、特に **B+Tree** インデックス構造の基本的な実装を通じて、データベース内部のデータ格納とアクセス方法への理解を深めることです。また、SQLパーサーと自作ストレージエンジンを連携させる基本的な流れを体験し、将来的なトランザクション機能の導入を見据えた基礎設計を行うことも目的とします。

## 2. 主要機能

### 2.1 コア機能

-   **テーブル作成:**
    -   単純な `CREATE TABLE table_name (id INTEGER PRIMARY KEY, column1 TEXT, column2 INTEGER)` 形式のSQLをサポートします。
    -   主キーは `id` という名前の INTEGER 型で、自動的にB+Treeのキーとして使用されます。
    -   テーブル定義（スキーマ情報）はメモリ上に保持します。
-   **データ挿入:**
    -   `INSERT INTO table_name (id, column1, ...) VALUES (?, ?, ...)` 形式のSQLをサポートします。
    -   指定された `id` をキー、他のカラムデータをシリアライズしたものをバリューとしてB+Treeに格納します。
-   **データ検索 (主キー):**
    -   `SELECT column1, column2 FROM table_name WHERE id = ?` 形式のSQLをサポートします。
    -   B+Treeを検索し、該当するキーのバリューをデシリアライズして返します。
-   **データ削除 (主キー):**
    -   `DELETE FROM table_name WHERE id = ?` 形式のSQLをサポートします。
    -   B+Treeから指定されたキーのエントリを削除します。

### 2.2 発展機能 (時間があれば実装)

-   **データ検索 (全件スキャン):**
    -   `SELECT * FROM table_name` 形式のSQLをサポートします。
    -   B+Treeのリーフノードをすべて走査して全データを返します。
-   **データ検索 (範囲スキャン):**
    -   `SELECT * FROM table_name WHERE id > ? AND id < ?` (または `>=`/`<=`) 形式のSQLをサポートします。
    -   B+Treeのリーフノードを範囲指定で走査します。
-   **永続化:**
    -   B+Treeのノードデータを「ページ」としてファイルに保存・読み込みする機能を追加します。
    -   起動時にデータファイルを読み込み、`COMMIT`